name: AQUA tests with pip

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1" #run every Monday night at 3AM UTC

jobs:
  aqua_test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '${{ matrix.python-version }}'
          cache: 'pip' # caching pip dependencies
          cache-dependency-path: |
            **/pyproject.toml
      - name: Provision with pip
        run: |
          # We need to install cdo as we do not have conda here. Note that
          # cdo has a dependency on libeccodes-data and libeccodes0. Apparently,
          # installing it is enough to get tests that rely on cdo and ecCodes
          # to work on Ubuntu.
          # NOTE: tested two cache actions, but in the end looks like eccodes
          #       does not work very well when the apt package is cached.
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cdo

          # Update pip because we are using pyproject.toml (needs newer pip)
          python -m pip install -U pip

          # Install with test dependencies
          python -m pip install -e .[tests]
      - name: Download and setup tests
        run: |
          ./download_data_for_tests.sh
      - name: Run tests
        run: |
          pytest -m "aqua or slow"

