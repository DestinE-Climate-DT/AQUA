"""Test ensemble Zonal EnsembleZonal module"""
import os
import subprocess
import pytest
import xarray as xr
import numpy as np
from aqua import Reader
from aqua.diagnostics import EnsembleZonal

@pytest.mark.ensemble
def test_Zonal_datasets():
    """
    load aqua-analysis output of Zonal-Averages.
    """
    #dataset = xr.open_dataset('../../AQUA_tests/models/NEMO/results/IFS-NEMO-historical-1990-lra-r100-monthly_zonal_mean_trend_atlantic_ocean.nc')
    reader = Reader(model='NEMO', exp='results', source='zonal_mean-latlev', catalog='ci', areas=False)
    dataset = reader.retrieve()

    dataset_list = [dataset,dataset]
    dataset = xr.concat(dataset_list, "Ensembles")
    del dataset_list
    return dataset

@pytest.mark.ensemble
def test_ensemble_Zonal_compute():
    """Test the compute method of EnsembleZonal."""
    sample_dataset = test_Zonal_datasets()
    Zonal = EnsembleZonal(var="so", dataset=sample_dataset)
    Zonal.compute_statistics()
    Zonal.plot()

    assert Zonal.dataset_mean.all() is not None
    assert Zonal.dataset_std.any() == 0 or np.nan # this step needs correction
    assert Zonal.figure is not None   

